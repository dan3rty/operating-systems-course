# Лабораторная работа №1

- [Лабораторная работа №1](#лабораторная-работа-1)
  - [Работа в консоли Linux](#работа-в-консоли-linux)
  - [Задания](#задания)
    - [Задание 1 — sys-info-win — 20 баллов](#задание-1--sys-info-win--20-баллов)
      - [Пример выводимой информации](#пример-выводимой-информации)
      - [Подсказки](#подсказки)
    - [Задание 2 — sys-info-linux — 20 баллов](#задание-2--sys-info-linux--20-баллов)
      - [Пример выводимой информации](#пример-выводимой-информации-1)
      - [Подсказки](#подсказки-1)
    - [Задание 3 — sys-info-crossplatform — 30 баллов](#задание-3--sys-info-crossplatform--30-баллов)
      - [Подсказки](#подсказки-2)
    - [Задание 4](#задание-4)
      - [Вариант 1 — SecretFunction — 50 баллов](#вариант-1--secretfunction--50-баллов)
      - [Вариант 2 — EncodeChar — 80 баллов](#вариант-2--encodechar--80-баллов)
    - [Задание 5 — знакомство с командами Linux — 80 баллов](#задание-5--знакомство-с-командами-linux--80-баллов)
  - [ССылки](#ссылки)

## Работа в консоли Linux

Выполнить команду с правами привилегированного пользователя

## Задания

- Для получения оценки "удовлетворительно" нужно набрать не менее 100 баллов.
- На оценку хорошо нужно набрать не менее 150 баллов.
- Для получения оценки "отлично" нужно набрать не менее 200 баллов.

### Задание 1 — sys-info-win — 20 баллов

Напишите программу sys-info-win для ОС Windows, которая бы выводила в консоль информацию о компьютере на котором она запущена:

- Версия операционной системы
- Количество свободной и имеющейся оперативной памяти (в мегабайтах)
- Количество ядер процессора

#### Пример выводимой информации

```txt
OS: Windows 10 or Greater
RAM: 6417MB / 7796MB
Processors: 16
```

#### Подсказки

Начиная с Windows 8.1 Microsoft не рекомендует приложениям привязываться к версии операционной системы,
поэтому функции вроде [`GetVersionEx`](https://learn.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-getversionexw)
могут возвращать недостоверную информацию о версии операционной системы.

Используйте [вспомогательные функции Windows](https://learn.microsoft.com/en-us/windows/win32/sysinfo/version-helper-apis),
чтобы узнать информации о версии ОС.

Узнать количество процессоров можно функцией [`GetSystemInfo`](https://learn.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsysteminfo)
и [`GetNativeSystemInfo`](https://learn.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-getnativesysteminfo).

Узнать информацию о памяти компьютера можно функций [`GlobalMemoryStatusEx`](GlobalMemoryStatusEx).

### Задание 2 — sys-info-linux — 20 баллов

Напишите программу sys-info-linux для ОС Linux, которая бы выводила в консоль информацию о компьютере, на котором запущена:

- Версия операционной системы
- Количество свободной и имеющейся оперативной памяти (в мегабайтах)
- Количество логических процессоров

#### Пример выводимой информации

```txt
OS: Linux 5.15.153.1-microsoft-standard-WSL2
RAM: 6417MB / 7796MB
Processors: 16
```

#### Подсказки

- Используйте функции `get_nprocs_conf`, `uname`, `sysinfo`, чтобы получить необходимую информацию.

### Задание 3 — sys-info-crossplatform — 30 баллов

Разработайте класс `SysInfo`, предоставляющий методы для получения информации о системе из заданий:

- Название и версия ОС
- Количество логических процессоров
- Количество свободной и установленной оперативной памяти

Класс должен быть возможно скомпилировать как под Windows, так и под Linux. Публичный интерфейс класса представлен ниже.

```c++
class SysInfo
{
public:
    std::string GetOSName() const;
    std::string GetOSVersion() const;
    uint64_t GetFreeMemory() const;
    uint64_t GetTotalMemory() const;
    unsigned GetProcessorCount() const;
};
```

Разработайте на основе этого класса консольное приложение **sys-info**, выводящее в консоль информацию о компьютере
и операционной системе.

Для сборки приложения должна использоваться система сборки CMake.
Приложение должно собираться как под Windows, так и под Linux.

#### Подсказки

- Используйте директивы управления компиляцией `#ifdef`, `#ifndef`, `#else`, `#endif` и другие,
чтобы подключить нужные заголовочные функции и использовать необходимые функции.

### Задание 4

Вы можете выполнить один или несколько вариантов заданий.

#### Вариант 1 — SecretFunction — 50 баллов

Один программист написал для одной очень важной программы очень важную функцию на ассемблере для процессоров семейства x86-64,
а потом со скандалом уволился и прекратил сотрудничество с компанией.

Вскоре выяснилось, что эта функция работает недостаточно быстро при больших значениях входных параметров.
Кроме того возникла необходимость портировать программу на другие процессорные архитектуры, такие как ARM и RISC V.

Вас наняли, чтобы решить эту проблему. Вы должны:

- Восстановите алгоритм работы этой функции.
- Дайте её подходящее имя.
- Перепишите её на языке C или C++, чтобы она была более читаемой.
- Оптимизируйте её работу.

Известно, что входной параметр функция принимает в регистре `EDI`, а возвращает результат в регистре `EAX`.

Исходный код функции представлен ниже:

```assembly
Foo:
        xor     eax, eax
        cmp     edi, 1
        jle     .L1
        cmp     edi, 2
        je      .L6
        test    dil, 1
        je      .L1
        mov     ecx, 2
        jmp     .L3
.L4:
        mov     eax, edi
        cdq
        idiv    ecx
        test    edx, edx
        je      .L8
.L3:
        add     ecx, 1
        cmp     edi, ecx
        jne     .L4
.L6:
        mov     eax, 1
        ret
.L8:
        xor     eax, eax
.L1:
        ret
```

Для демонстрации работы написанной функции напишите программу, которая:

- считывает из stdin значение аргумента
- вызывает написанную вами функцию и выводит её результат в stdout.

Программа должна собираться системой сборки CMake под Windows и Linux.

#### Вариант 2 — EncodeChar — 80 баллов

Спецслужбы перехватили шпиона, отправившего зашифрованное послание «Naq rju 5rj fu gorj qsw!».
При себе у него было обнаружено шифровальное устройство, в прошивке которого была функция `EncodeChar`.
Эта функция использовалась для кодирования каждого символа исходного сообщения.

Вот что известно о функции `EncodeChar`:

- Она принимает в регистре `EDI` код шифруемого символа.
- В регистре `EAX` возвращает зашифрованный символ.

Вас наняли, чтобы восстановить алгоритм шифрования и написать программу дешифровки секретных сообщений.

Исходный код функции `EncodeChar` дан ниже.

```assembly
EncodeChar:
        lea     eax, [rdi-65]
        cmp     al, 25
        jbe     .L15
        lea     eax, [rdi-97]
        cmp     al, 25
        jbe     .L16
        lea     edx, [rdi-48]
        mov     eax, edi
        cmp     dl, 9
        jbe     .L17
        ret
.L16:
        movsx   edi, dil
        lea     edx, [rdi-485+rdi*4]
        mov     rax, rdx
        imul    rdx, rdx, 1321528399
        shr     rdx, 35
        imul    edx, edx, 26
        sub     eax, edx
        add     eax, 97
        ret
.L15:
        movsx   edi, dil
        mov     eax, 90
        sub     eax, edi
        lea     edx, [rax+rax*2]
        mov     rax, rdx
        imul    rdx, rdx, 1321528399
        shr     rdx, 35
        imul    edx, edx, 26
        sub     eax, edx
        add     eax, 65
        ret
.L17:
        movsx   edi, dil
        mov     eax, 57
        mov     ecx, 3435973837
        sub     eax, edi
        imul    edx, eax, 23
        mov     rax, rdx
        imul    rdx, rcx
        shr     rdx, 35
        lea     edx, [rdx+rdx*4]
        add     edx, edx
        sub     eax, edx
        add     eax, 48
        ret
```

Восстановите алгоритм шифрования символов и напишите функцию `char DecodeChar(char ch)`,
которая декодирует переданный символ.
На её основе напишите функцию `std::string DecodeString(const std::string& str)`, декодирующую строку.

Используя функцию `DecodeString` напишите программу, которая считывает зашифрованное сообщение из stdin
и выводит расшифрованное сообщение в stdout.

Программа должна собираться системой сборки CMake под Windows и Linux.

### Задание 5 — знакомство с командами Linux — 80 баллов

Ознакомьтесь с работой некоторых команд Linux.

Чтобы получить инструкцию об использовании той или иной команды, используйте программу `man` (от слова manual).
Для этого в консоли введите:

```bash
man название-команды
```

Например так можно получить инструкцию по команде `cd`:

```bash
man cd
```

- Командой `mkdir` создайте каталог *out*. Если такой каталог уже есть,
то рекурсивно удалите содержимое каталога командой `rm`. Узнать о наличии каталога можно командой `test`.
- Перейдите внутрь каталога *out* командой `cd`.
- Внутри каталога *out* создайте файл *me.txt*, содержимое которого — имя текущего пользователя.
Чтобы узнать имя пользователя, перенаправьте вывод команды `whoami` в соответствующий файл.
- Создайте файл *metoo.txt*, скопировав содержимое файла *me.txt* командой `cp` в файл *metoo.txt*.
- Создайте файл *wchelp.txt*, содержащий документацию о работе команды `wc`.
  - Подсказка: перенаправьте вывод команды `man wc` в соответствующий файл.
- Выведите содержимое файла *wchelp.txt* в консоль, используя команду `cat`.
- Выведите в файл *wchelp-lines.txt* количество строк в файле *wchelp.txt*.
  - Для этого воспользуйтесь командами `wc` и `cut`.
  - Подайте вывод команды `wc` на вход команде `cut`, используя операцию `|`:

    ```sh
    wc параметры-команды-wc | cut параметры-команды-cut >файл-куда-вывести-результат
    ```

- Создайте файл *wchelp-reversed.txt*, содержимое которого составлено из строк файла *wchelp.txt*,
расположенных в обратном порядке.
Для этого воспользуйтесь командой `tac`.
- Создайте файл *all.txt*, содержимое которого составлено из строк файлов:
  *wchelp.txt*, *wchelp-reversed.txt*, *me.txt*, *metoo.txt*, *wchelp-lines.txt*.
  Для объединения содержимого файлов используйте команду `cat`.
- Командой `tar` создайте архив *result.tar*, содержащий все файлы текущего каталога, имеющие расширение *.txt*.
- Командой `gzip` скомпрессируйте *result.tar* в файл *result.tar.gz*.
- Выйдите из каталога *out* в родительский каталог, используя команду `cd`.
- Переместите командой `mv` файл *out/result.tar.gz* в текущий каталог.
  - Предварительно проверьте наличие файла result.tar.gz в текущем каталоге командой `test`.
  - Если такой файл был, удалите его командой `rm` перед перемещением нового файла из каталога *out*.
- Удалите каталог *out* командой `rmdir`.

Результат работы оформите в виде скрипта *solution.sh* со следующим содержимым:

```bash
#!/usr/bin/env bash
# Предыдущая строка сообщает загрузчику программы, что надо использовать оболочку bash

# Если любая из следующий команд завершится неудачей, скрипт прекратит свою работу
set -e

# Тут поместите остальные команды
```

## ССылки

- [Список Windows API](https://learn.microsoft.com/en-us/windows/win32/apiindex/windows-api-list)
- [Linux man-pages project](https://www.kernel.org/doc/man-pages/) - поисковик по документации ядра Linux.
- [Система сборки CMake](https://cmake.org/).
- [Intel® 64 and IA-32 Architectures Software Developer’s Manual](https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html)
  - Для доступа к сайту используйте VPN либо браузер Tor.
- [Linux Pocket Guide](https://linuxpocketguide.com/)
- Принимаются Pull Request-ы
